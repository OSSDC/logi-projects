
from ugv_platform import UgvPlatform
from waypoint_provider import StaticWayPointProvider
from controllers import PathController as Controller

import time

from gps_service import GpsService
from math import radians, cos, sin, asin, sqrt, atan2 , degrees

ESC_ARM_ANGLE = 0.0

def populateSensorMap(robot, gps_service):
	#pos = gps_service.getPosition()
	#valid, euler, gyro  = robot.getPlatformAttitude()
	#print euler
	sensor_map = {}
	sensor_map[Controller.imu_key] = (euler, gyro)
	sensor_map[Controller.gps_key] = GpsService.getPosition()
	#TODO: add odometry and blobs
	return sensor_map
	

if __name__ == "__main__":
	robot = UgvPlatform()
	#robot.setColorLut('lut_file.lut')
	#robot.initImu('accelcal.txt', 'magcal.txt')
	wp = StaticWayPointProvider()
	#gps_service = GpsService()
	controller = Controller()
	#gps_service.start()
	robot.setSteeringFailSafe(0.0)
	robot.setSpeedFailSafe(ESC_ARM_ANGLE)
	robot.resetWatchdog()
	robot.setSteeringAngle(0.0)
	robot.setSpeed(128)
	try:
		while True:
			robot.resetWatchdog()
			#target_pos= wp.getCurrentWayPoint()
			current_pos = gps_service.getPosition()
			print current_pos
			#sensors = populateSensorMap(robot, gps_service)
			sensors = {}
			#if len(sensors) == 0:
			#	time.sleep(0.1)
			#	continue	
			cmd = controller.getCommand(sensors)
			if cmd == None:
				break
			print str(cmd)
			if cmd.has_key(Controller.next_waypoint_key) and cmd[Controller.next_waypoint_key] != None and cmd[Controller.next_waypoint_key] == 1:
				wp.getNextWaypoint()
			else:	
				robot.setSteeringAngme(cmd[Controller.steering_key])
				robot.setSpeed(cmd[Controller.speed_key])
			time.sleep(0.20)
	except KeyboardInterrupt:
    		controller.close()
		exit()

	robot.setSteeringAngle(0.0)        
	robot.setSpeed(128)
	print "Shutdown ESC then quit programm (for safety reason)"
        while True:
		time.sleep(1)	

